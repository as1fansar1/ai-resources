# Nightly Build Log

Add one entry per nightly run.

## Template
- Date:
- Built:
- Why this step:
- Key technical concepts:
- Files changed:
- Risks/limitations:
- Next step:

---

- Date: 2026-02-17
- Built: Initial FastAPI skeleton with application factory and `/health` endpoint, plus pinned runtime deps and a health endpoint test scaffold.
- Why this step: It is the top-priority item in `NEXT_STEPS.md` and creates a runnable API foundation for all upcoming LLM integration work.
- Key technical concepts:
  - FastAPI app factory (`create_app`) for easier testing and future config injection.
  - Liveness probe pattern via lightweight `/health` endpoint.
  - Dependency pinning (`requirements.txt`) to reduce environment drift.
  - Test-first API contract setup with `fastapi.testclient.TestClient`.
- Files changed:
  - `app/main.py`
  - `tests/test_health.py`
  - `requirements.txt`
- Risks/limitations:
  - Runtime test execution not performed yet because dependencies are not installed in this environment.
  - No startup config/env handling yet.
- Next step: Implement an OpenRouter client wrapper with clean interface, timeout handling, and basic error mapping.

- Date: 2026-02-17
- Built: Added a minimal OpenRouter client wrapper (`OpenRouterClient`) with env-based config loading, timeout/error mapping, and focused unit tests for success + failure paths.
- Why this step: It was the highest-priority remaining item and unlocks safe model-call plumbing before adding `/analyze`.
- Key technical concepts:
  - API client wrapper pattern to isolate third-party integration details.
  - Environment-driven secrets/config (`OPENROUTER_API_KEY`, timeout override).
  - Error taxonomy (`ConfigError`, `RequestError`, `TimeoutError`) so API routes can map failures cleanly.
  - Dependency injection in tests via monkeypatching `httpx.Client` to keep tests deterministic.
- Files changed:
  - `app/openrouter_client.py`
  - `tests/test_openrouter_client.py`
  - `requirements.txt`
- Risks/limitations:
  - Sanity check command `pytest -q` is currently blocked in this environment (`pytest: command not found`) until dependencies are installed.
  - Wrapper currently returns raw completion JSON; response normalization is not implemented yet.
- Next step: Add first `/analyze` endpoint with deterministic mock + response schema, then swap in OpenRouter behind the same contract.

- Date: 2026-02-18
- Built: Implemented first `/analyze` endpoint with explicit request/response schema and deterministic mock analysis logic, plus endpoint tests.
- Why this step: It was the top-priority item in `NEXT_STEPS.md` and creates a stable API contract Asif can build UI/client code against before real LLM wiring.
- Key technical concepts:
  - Pydantic request/response contracts (`AnalyzeRequest`, `AnalyzeResponse`) for predictable API behavior.
  - Deterministic mock generation via keyword-based theme detection so outputs are testable and reproducible.
  - Contract-first endpoint development to decouple product/API design from model integration timing.
  - Validation guardrails (`feedback` list must contain at least one item).
- Files changed:
  - `app/main.py`
  - `tests/test_analyze.py`
- Risks/limitations:
  - `/analyze` is still mock-only; it does not call OpenRouter yet.
  - `pytest -q` remains unavailable in this environment (`pytest: command not found`), so sanity check used `python3 -m compileall app tests`.
- Next step: Wire dependency installation + a one-command smoke test (`make smoke`) so tests can run reliably in nightly jobs.

- Date: 2026-02-19
- Built: Added a one-command smoke workflow via `Makefile` (`make smoke`) with dependency install wiring and environment-aware fallback, plus README setup guidance.
- Why this step: It was the highest-priority item in `NEXT_STEPS.md` and is foundational for fast, repeatable nightly validation as model integration complexity increases.
- Key technical concepts:
  - Build automation with `make` to standardize local/nightly run commands.
  - Progressive install strategy: try isolated `.venv` first, then fallback to user-site install.
  - Smoke-test scope control: run only core API contract checks (`tests/test_health.py`, `tests/test_analyze.py`) for speed.
  - Environment diagnostics as part of DX: documented apt prerequisites when Python packaging modules are missing.
- Files changed:
  - `Makefile`
  - `README.md`
  - `docs/NEXT_STEPS.md`
- Risks/limitations:
  - Current runtime remains blocked from fully executing `make smoke` because both `venv` bootstrap (`ensurepip`) and `pip` module are missing.
  - Until host prerequisites are installed, fallback sanity check remains `python3 -m compileall app tests`.
- Next step: Add OpenRouter response parser utility to safely extract assistant text from completion payload.

- Date: 2026-02-21
- Built: Added `extract_assistant_text` parser utility for OpenRouter completion payloads with strict error signaling, plus focused unit tests for plain text, content-block, and failure scenarios.
- Why this step: It was the highest-priority open item in `NEXT_STEPS.md` and is required before wiring `/analyze` to a live model response safely.
- Key technical concepts:
  - Response normalization layer to shield route code from provider payload shape changes.
  - Defensive parsing for mixed-content message blocks (`[{"type":"text", ...}]`).
  - Explicit parse errors (`OpenRouterParseError`) to keep downstream error mapping predictable.
  - Test-driven contract checks for happy path + malformed payloads.
- Files changed:
  - `app/openrouter_parser.py`
  - `tests/test_openrouter_parser.py`
  - `docs/NEXT_STEPS.md`
  - `docs/NIGHTLY_LOG.md`
- Risks/limitations:
  - Full pytest run remains blocked in this environment due to missing pytest binary/pip bootstrap in `.venv`; sanity check used `python3 -m compileall app tests`.
  - Parser currently extracts assistant text only; it does not normalize tool calls or metadata.
- Next step: Connect `/analyze` to OpenRouter behind the existing response contract, with mock fallback for local/dev mode.

- Date: 2026-02-21
- Built: Wired `/analyze` to OpenRouter behind a mode flag (`INSIGHT2SPEC_ANALYZE_MODE=openrouter`) while preserving the existing response schema and adding automatic mock fallback on provider/config/parser failures.
- Why this step: It was the highest-priority item in `NEXT_STEPS.md` and unlocks first end-to-end LLM integration without breaking frontend/client contracts.
- Key technical concepts:
  - Contract-preserving integration: keep `AnalyzeResponse` stable while swapping summary generation source.
  - Feature flag pattern for local/dev safety (`mock` default, `openrouter` opt-in).
  - Graceful degradation: catch OpenRouter + parse errors and return deterministic mock analysis.
  - Isolation testing with monkeypatching to simulate provider success/failure without network calls.
- Files changed:
  - `app/main.py`
  - `app/openrouter_client.py`
  - `tests/test_analyze.py`
  - `docs/NEXT_STEPS.md`
  - `docs/NIGHTLY_LOG.md`
- Risks/limitations:
  - Fallback currently masks detailed provider errors from API clients; explicit route-level HTTP error mapping is still pending.
  - OpenRouter path currently only replaces `summary`; structured fields still come from deterministic logic.
  - Sanity check used `python3 -m compileall app tests` because pytest tooling is not available in this runtime.
- Next step: Add CI/devcontainer bootstrap so `make smoke` works in fresh environments without manual apt setup (`python3-pip`, `python3.12-venv`).

- Date: 2026-02-21
- Built: Added CI and devcontainer bootstrap for repeatable `make smoke` setup: new `requirements.txt`, `Makefile` bootstrap/smoke targets, GitHub Actions smoke workflow with apt prerequisites, and devcontainer post-create bootstrap.
- Why this step: It was the top-priority item in `NEXT_STEPS.md` and removes manual machine setup friction so nightly validation can be automated and teach a clean build pipeline pattern.
- Key technical concepts:
  - Environment bootstrap layering: OS deps (`python3-pip`, `python3.12-venv`) + Python deps (`requirements.txt`).
  - Single-command developer workflow via `make bootstrap` / `make smoke`.
  - CI parity with local/devcontainer flow to reduce “works on my machine” drift.
  - Graceful smoke fallback (`compileall`) when pytest tooling is unavailable.
- Files changed:
  - `requirements.txt`
  - `Makefile`
  - `.github/workflows/smoke.yml`
  - `.devcontainer/devcontainer.json`
  - `docs/NEXT_STEPS.md`
  - `docs/NIGHTLY_LOG.md`
- Risks/limitations:
  - Current runtime still lacks pytest in `.venv`, so local sanity check used `make smoke` fallback path (`python3 -m compileall app tests`).
  - CI currently installs apt packages directly in workflow; build speed can be improved later with caching or prebuilt images.
- Next step: Add route-level error mapping for OpenRouter failures (config/request/timeout/parse) so API responses stay explicit and debuggable.

- Date: 2026-02-22
- Built: Implemented explicit `/analyze` route-level OpenRouter error mapping (config/request/timeout/parse) to structured HTTP errors instead of silent mock fallback; added endpoint tests for config + timeout mappings.
- Why this step: It was the highest-priority item in `NEXT_STEPS.md` and improves debuggability for API consumers learning production LLM integration patterns.
- Key technical concepts:
  - Error taxonomy to HTTP contract mapping (`500` config, `504` timeout, `502` request/parse).
  - Structured error payloads with stable machine-readable `code` fields.
  - Fail-fast provider mode behavior (no hidden fallback) to surface integration issues early in dev.
  - Test isolation with monkeypatched clients to validate error paths without network calls.
- Files changed:
  - `app/main.py`
  - `tests/test_analyze.py`
  - `docs/NEXT_STEPS.md`
  - `docs/NIGHTLY_LOG.md`
- Risks/limitations:
  - `response_model` still documents only success payloads; OpenAPI error schema coverage is not added yet.
  - Sanity check used `make smoke` compile fallback because pytest is unavailable in the current runtime environment.
- Next step: Parse structured OpenRouter output (themes/opportunities/experiments) into first-class response fields instead of mock-derived placeholders.

- Date: 2026-02-23
- Built: Replaced OpenRouter-mode mock-derived fields with structured provider parsing by requiring JSON output and mapping `summary/themes/opportunities/experiments/prd_outline` directly into `AnalyzeResponse`; added parser + endpoint tests for structured extraction and invalid JSON handling.
- Why this step: It was the highest-priority item in `NEXT_STEPS.md` and turns `/analyze` into a truer LLM-integration example (not just LLM summary + deterministic placeholders), which is more educational for AI engineering workflows.
- Key technical concepts:
  - Prompt-contract pairing: the route now requests strict JSON with explicit fields to reduce downstream ambiguity.
  - Structured output validation: parser enforces non-empty summary and list-string contracts with explicit parse errors.
  - Provider-contract mapping: openrouter mode now returns provider-derived insight fields instead of reusing deterministic mock generation.
  - Defensive parsing supports both raw JSON and fenced ```json blocks.
- Files changed:
  - `app/openrouter_parser.py`
  - `app/main.py`
  - `tests/test_openrouter_parser.py`
  - `tests/test_analyze.py`
  - `docs/NEXT_STEPS.md`
  - `docs/NIGHTLY_LOG.md`
- Risks/limitations:
  - Strict JSON expectation can still fail if model drifts; currently this surfaces as `openrouter_parse_error` rather than auto-retry/repair.
  - `prd_outline` remains optional (empty list allowed) to avoid overfailing on partial model outputs.
  - Sanity check used `make smoke` compile fallback (`python3 -m compileall app tests`) because pytest is unavailable in this runtime environment.
- Next step: Add a minimal README quickstart for local and devcontainer workflows (mode flags, smoke command, env vars).
